#!/usr/bin/env node
const path = require("path");
const { spawn } = require("cross-spawn");

const script = process.argv.length > 2 ? process.argv[2] : null;
const args = process.argv.slice(3);

const printHelp = () => {
  const { stripIndent } = require("common-tags");
  console.log(stripIndent`
    Usage : pigment <script> [arguments]

    Available scripts:
      help         Displays this help message
      start        Launches your application in developer mode
      build        Builds all the files needed for production usage
      serve        Serve production server
      test         Runs your jest tests
      test:perf    Checks site's performance through lighthouse CLI

    For further information on each available script, please
    use the help command after your script name.
      pigment start help
  `);
};

const startProcess = (script, args) => {
  let nodeArgs = [];
  const inspectArg = process.argv.find(arg => arg.includes("--inspect"));
  if (inspectArg) {
    nodeArgs.push(inspectArg);
  }

  const proc = spawn("node", [...nodeArgs, ...[script], ...args], {
    stdio: "inherit",
    customFds: [0, 1, 2]
  });
  proc.on("close", (code, signal) => {
    if (code !== null) {
      process.exit(code);
    }
    if (signal) {
      if (signal === "SIGKILL") {
        process.exit(137);
      }
      console.log(`got signal ${signal}, exiting`);
      process.exit(signal === "SIGINT" ? 0 : 1);
    }
    process.exit(0);
  });
  proc.on("error", err => {
    console.error(err);
    process.exit(1);
  });

  const wrapper = (...e) => {
    if (proc) {
      proc.kill();
    }
  };
  process.on("SIGINT", wrapper);
  process.on("SIGTERM", wrapper);
  process.on("exit", wrapper);
};

switch (script) {
  case "start":
    startProcess(path.join(__dirname, "../src/scripts/start.js"), args);
    break;
  case "build":
    startProcess(path.join(__dirname, "../src/scripts/build.js"), args);
    break;
  case "serve":
    startProcess(path.join(__dirname, "../src/scripts/serve.js"), args);
    break;
  case "test":
    startProcess(path.join(__dirname, "../src/scripts/test.js"), args);
    break;
  case "test:perf":
    startProcess(path.join(__dirname, "../src/scripts/test.perf.js"), args);
    break;
  case "help":
    console.log("Welcome to Pigment.js!");
    printHelp();
    break;
  default:
    console.log('Unknown script "' + script + '".');
    printHelp();
    exit(1);
    break;
}
